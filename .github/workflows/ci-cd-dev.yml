name: CI/CD Pipeline - DEV

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev

jobs:
  test:
    name: Test Stage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest
      
      - name: Setup - Validate and Download Resources
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_BUCKET: ${{ secrets.AWS_BUCKET }}
          MODEL_FILE: ${{ secrets.MODEL_FILE_DEV }}
          ENV: dev
        run: |
          python scripts/setup.py
      
      - name: Pre-training - Validate Model with Training Data
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_BUCKET: ${{ secrets.AWS_BUCKET }}
          MODEL_FILE: ${{ secrets.MODEL_FILE_DEV }}
          ENV: dev
        run: |
          python scripts/pretrain.py
      
      - name: Run unit tests
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_BUCKET: ${{ secrets.AWS_BUCKET }}
          MODEL_FILE: ${{ secrets.MODEL_FILE_DEV }}
          ENV: dev
        run: |
          python -m pytest test/test_model.py -v --tb=short
      
      - name: Test Results
        if: always()
        run: echo "✓ All tests passed for DEV environment"

  build:
    name: Build & Deploy Stage - DEV
    runs-on: ubuntu-latest
    needs: test
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/iris-model:dev-latest
            ${{ secrets.DOCKER_USERNAME }}/iris-model:dev-${{ github.sha }}
          build-args: |
            AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
            AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
            AWS_BUCKET=${{ secrets.AWS_BUCKET }}
            MODEL_FILE=${{ secrets.MODEL_FILE_DEV }}
            ENV=dev
      
      - name: Deploy to Cloud Run - DEV
        run: |
          echo "Deploying to Cloud Run DEV endpoint..."
          echo "Image: ${{ secrets.DOCKER_USERNAME }}/iris-model:dev-latest"
          # Aquí va el comando de despliegue a Google Cloud Run o tu servicio de nube
          # gcloud run deploy iris-model-dev --image=${{ secrets.DOCKER_USERNAME }}/iris-model:dev-latest
      
      - name: Deploy to AWS App Runner - DEV
        run: |
          echo "Deploying to AWS App Runner DEV endpoint..."
          # Aquí va el comando de despliegue a AWS App Runner
          # aws apprunner start-deployment --service-arn arn:aws:apprunner:region:account:service/iris-model-dev
      
      - name: Deployment Complete
        run: echo "✓ DEV deployment completed successfully"
