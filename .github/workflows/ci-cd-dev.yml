name: CI/CD Pipeline - DEV

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev

jobs:
  test:
    name: Test Stage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest
      
      - name: Setup - Validate and Download Resources
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_BUCKET: ${{ secrets.AWS_BUCKET }}
          MODEL_FILE: ${{ secrets.MODEL_FILE_DEV }}
          ENV: dev
        run: |
          python scripts/setup.py
      
      - name: Pre-training - Validate Model with Training Data
        env:
          MODEL_FILE: ${{ secrets.MODEL_FILE_DEV }}
          ENV: dev
        run: |
          python scripts/pretrain.py
      
      - name: Run unit tests
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_BUCKET: ${{ secrets.AWS_BUCKET }}
          MODEL_FILE: ${{ secrets.MODEL_FILE_DEV }}
          ENV: dev
        run: |
          python -m pytest test/test_model.py -v --tb=short
      
      - name: Test Results
        if: always()
        run: echo "✓ All tests passed for DEV environment"

  build:
    name: Build & Deploy Stage - DEV
    runs-on: ubuntu-latest
    needs: test
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1
      
      - name: Build and push Docker image to ECR
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/iris-model:dev-latest
            ${{ steps.login-ecr.outputs.registry }}/iris-model:dev-${{ github.sha }}
          build-args: |
            AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
            AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
            AWS_BUCKET=${{ secrets.AWS_BUCKET }}
            MODEL_FILE=${{ secrets.MODEL_FILE_DEV }}
            ENV=dev
      
      - name: Deploy to EC2 - DEV (Port 8080)
        run: |
          ECR_IMAGE=${{ steps.login-ecr.outputs.registry }}/iris-model:dev-latest
          ENV=dev
          PORT=8080
          
          echo "Deploying DEV to EC2 instance..."
          echo "Environment: $ENV"
          echo "Port: $PORT"
          echo "ECR Image: $ECR_IMAGE"
          
          # Descargar la clave SSH desde S3
          echo "Downloading SSH key from S3..."
          aws s3 cp s3://${{ secrets.AWS_BUCKET }}/${{ secrets.SSH_KEY_S3_PATH }} ./ec2-key.ppk
          chmod 600 ./ec2-key.ppk
          
          # Instancia SSH en EC2
          ssh -i ./ec2-key.ppk ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            # Variables
            ENV=dev
            PORT=8080
            ECR_IMAGE=${{ steps.login-ecr.outputs.registry }}/iris-model:dev-latest
            REGISTRY=${{ steps.login-ecr.outputs.registry }}
            REGION=${{ secrets.AWS_REGION }}
            
            # Descargar las credenciales de ECR
            aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $REGISTRY
            
            # Nombre del contenedor
            CONTAINER_NAME="iris-model-dev"
            
            # Detener contenedor anterior si existe
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true
            
            # Descargar la nueva imagen
            docker pull $ECR_IMAGE
            
            # Ejecutar contenedor en puerto 8080
            docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              -p 8080:8501 \
              -e AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }} \
              -e AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }} \
              -e AWS_BUCKET=${{ secrets.AWS_BUCKET }} \
              -e MODEL_FILE=${{ secrets.MODEL_FILE_DEV }} \
              -e ENV=dev \
              -e AWS_DEFAULT_REGION=${{ secrets.AWS_REGION }} \
              $ECR_IMAGE
            
            echo "DEV container deployed successfully on port 8080"
          EOF
          
          # Limpiar clave local
          rm -f ./ec2-key.ppk
      
      - name: Deployment Complete
        run: echo "✓ DEV deployment completed successfully"
