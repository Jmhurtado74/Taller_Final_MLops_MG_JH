name: CI/CD Pipeline - PROD

on:
  push:
    branches:
      - prod
  pull_request:
    branches:
      - prod

jobs:
  test:
    name: Test Stage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest
      
      - name: Setup - Validate and Download Resources
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_BUCKET: ${{ secrets.AWS_BUCKET }}
          MODEL_FILE: ${{ secrets.MODEL_FILE_PROD }}
          ENV: prod
        run: |
          python scripts/setup.py
      
      - name: Pre-training - Validate Model with Training Data
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_BUCKET: ${{ secrets.AWS_BUCKET }}
          MODEL_FILE: ${{ secrets.MODEL_FILE_PROD }}
          ENV: prod
        run: |
          python scripts/pretrain.py
      
      - name: Run unit tests
        env:
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_KEY }}
          AWS_BUCKET: ${{ secrets.AWS_BUCKET }}
          MODEL_FILE: ${{ secrets.MODEL_FILE_PROD }}
          ENV: prod
        run: |
          python -m pytest test/test_model.py -v --tb=short
      
      - name: Test Results
        if: always()
        run: echo "✓ All tests passed for PROD environment"

  build:
    name: Build & Deploy Stage - PROD
    runs-on: ubuntu-latest
    needs: test
    if: success()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/iris-model:prod-latest
            ${{ secrets.DOCKER_USERNAME }}/iris-model:prod-${{ github.sha }}
          build-args: |
            AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
            AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}
            AWS_BUCKET=${{ secrets.AWS_BUCKET }}
            MODEL_FILE=${{ secrets.MODEL_FILE_PROD }}
            ENV=prod
      
      - name: Deploy to Cloud Run - PROD
        run: |
          echo "Deploying to Cloud Run PROD endpoint..."
          echo "Image: ${{ secrets.DOCKER_USERNAME }}/iris-model:prod-latest"
          # Aquí va el comando de despliegue a Google Cloud Run o tu servicio de nube
          # gcloud run deploy iris-model-prod --image=${{ secrets.DOCKER_USERNAME }}/iris-model:prod-latest
      
      - name: Deploy to AWS App Runner - PROD
        run: |
          echo "Deploying to AWS App Runner PROD endpoint..."
          # Aquí va el comando de despliegue a AWS App Runner
          # aws apprunner start-deployment --service-arn arn:aws:apprunner:region:account:service/iris-model-prod
      
      - name: Deployment Complete
        run: echo "✓ PROD deployment completed successfully"
